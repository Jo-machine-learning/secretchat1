<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="icon" type="image/jpeg" href="images/image.jpg">

<title>John Secret Chatüí≠</title>
    

<style>
* { box-sizing: border-box; }
html, body { touch-action: manipulation; margin:0; padding:0; }
body { font-family: Arial, sans-serif; background: #e5e5e5; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
/* HEADER */
    
/* HEADER */
/* HEADER */
header { 
    background: rgba(0,0,0,1);
    color: #fff;
    text-align: center;
    padding: 1px 10px;
    font-size: 1.3rem;
    width: 100%;
    position: relative;
    margin-top: 0;
    backdrop-filter: blur(4px);
    max-height: 30px;
    overflow: hidden;
}

.real-time-clock, .online-users { position: fixed; top: 15px; padding: 5px 10px; font-size: 1rem; color: white; background-color: rgba(0,0,0,0.3); border-radius: 10px; z-index: 20; }
.real-time-clock { left: 15px; }
.online-users { right: 15px; }
/* CHAT AREA */
.chat-area { flex: 1; margin-top: 20px; margin-bottom: 80px; padding: 10px; overflow-y: auto; background: #f2f2f2; display: flex; flex-direction: column-reverse; }
#wishlistList { list-style:none; padding:0; margin:0; display:flex; flex-direction:column-reverse; gap:10px; }
.bubble { background:white; padding:12px 15px; border-radius:20px; max-width:80%; position:relative; animation: slideIn 0.3s; box-shadow:0 2px 4px rgba(0,0,0,0.1); display:flex; flex-direction:column; gap:5px; }
.bubble img { max-width:150px; border-radius:15px; margin-top:5px; }
video { max-width:200px; border-radius:15px; margin-top:5px; }
@keyframes slideIn { from {opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

/* ‚≠ê NEW ‚Äî Highlight full-width green neon */
.highlight-bubble {
    background: #ccff00 !important;
    width: 100% !important;
    border-radius: 10px !important;
    padding: 15px !important;
}

/* INPUT */
.input-container { position: fixed; bottom: 0; left: 0; width: 100%; background:#fff; padding:8px 10px; display:flex; align-items:center; gap:8px; box-shadow:0 -2px 4px rgba(0,0,0,0.15); }
.input-container input[type="text"] { flex:1; padding:12px; font-size:1rem; border-radius:20px; border:1px solid #ccc; }
.input-container button { background:#4a90e2; color:white; padding:12px 18px; border:none; font-size:1rem; border-radius:20px; cursor:pointer; flex-shrink:0; }
.input-container input[type="file"] { display:none; }
.file-label { font-size:22px; cursor:pointer; padding:8px; border-radius:50%; background:#f2f2f2; flex-shrink:0; user-select:none; }
#typingIndicator { font-size:0.9rem; color:#777; padding-left:10px; margin-bottom:5px; display:none; }

/* LOCK SCREEN */
#lockScreen { position: fixed; top:0; left:0; width:100%; height:100%; background: linear-gradient(180deg, #000000, #ffffff); display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:9999; gap:20px; }
#pinBoxes { display:flex; gap:10px; }
.pinBox { 
  width:45px; 
  height:55px; 
  text-align:center; 
  font-size:1.8rem; 
  border-radius:10px; 
  border:2px solid #fff; 
  background:#000000; 
  box-shadow:0 2px 6px rgba(0,0,0,0.2); 
}

#pinPad { display:grid; grid-template-columns:repeat(3,70px); gap:12px; margin-top:10px; }
.pinBtn { width:70px; height:70px; font-size:1.6rem; border:none; border-radius:15px; background:#fff; box-shadow:0 2px 4px rgba(0,0,0,0.3); cursor:pointer; color: #000000; }
.shake { animation: shakeAnim 0.3s; }
@keyframes shakeAnim {0%{transform:translateX(0);}25%{transform:translateX(-6px);}50%{transform:translateX(6px);}75%{transform:translateX(-6px);}100%{transform:translateX(0);} }

/* REFRESH */
#refreshBtn { position: fixed; top:70px; right:20px; padding:10px 15px; background: rgba(0,0,0,1); color:white; border:none; border-radius:5px; cursor:pointer; z-index:50; font-size:0.7rem; box-shadow:0 2px 6px rgba(0,0,0,0.3); transition:0.3s; }
#refreshBtn:hover{ transform:scale(1.05); box-shadow:0 4px 8px rgba(0,0,0,0.4); }

/* CELEBRATION */
#welcomeMsgLeft, #welcomeMsgRight { position: fixed; top:50%; transform:translateY(-50%); font-size:2rem; font-weight:bold; color:white; text-shadow:0 2px 6px rgba(0,0,0,0.5); opacity:0; z-index:99999; pointer-events:none; white-space:nowrap; }
#welcomeMsgLeft { left: -100%; }
#welcomeMsgRight { right: -100%; }
@keyframes slideFromLeft { 0%{left:-100%;opacity:0;}50%{left:50%;opacity:1;}100%{left:-100%;opacity:0;} }
@keyframes slideFromRight { 0%{right:-100%;opacity:0;}50%{right:50%;opacity:1;}100%{right:-100%;opacity:0;} }
.confetti-piece { position: fixed; width:10px; height:10px; background:red; top:0; left:50%; opacity:0.9; z-index:99998; animation: fall 3s linear forwards; }
@keyframes fall { 0% { transform: translateY(0) rotate(0deg); opacity:1; } 100% { transform: translateY(100vh) rotate(720deg); opacity:0; } }
.input-container textarea {
flex:1;
padding:12px;
font-size:1rem;
border-radius:20px;
border:1px solid #ccc;
resize:none;
overflow:hidden;
min-height:45px;
max-height:150px;
white-space:pre-wrap;
}
/* ===== SECTION SYSTEM ===== */

#sectionsBar{
    display:flex;
    gap:8px;
    padding:6px 10px;
    background:#111;
    overflow-x:auto;
    border-bottom:1px solid #333;
}

.sectionTab{
    background:#333;
    color:#fff;
    padding:6px 14px;
    border-radius:14px;
    cursor:pointer;
    white-space:nowrap;
    font-size:0.85rem;
    user-select:none;
}

.sectionTab.active{
    background:#ccff00;
    color:#000;
    font-weight:bold;
}

.sectionTab.add{
    background:#4caf50;
    font-weight:bold;
}

.sectionTab.del{
    background:#e53935;
    font-weight:bold;
}

</style>
</head>
<body>
    
<!-- LOCK SCREEN -->
<div id="lockScreen">
<h2 style="color:white; text-shadow:0 2px 4px rgba(0,0,0,0.3);">Enter PIN to Access Chat</h2>
<div id="pinBoxes">
<input class="pinBox" disabled>
<input class="pinBox" disabled>
<input class="pinBox" disabled>
<input class="pinBox" disabled>
</div>
<div id="pinPad">
<button class="pinBtn">1</button>
<button class="pinBtn">2</button>
<button class="pinBtn">3</button>
<button class="pinBtn">4</button>
<button class="pinBtn">5</button>
<button class="pinBtn">6</button>
<button class="pinBtn">7</button>
<button class="pinBtn">8</button>
<button class="pinBtn">9</button>
<button class="pinBtn" id="welBoss">üëë</button>
<button class="pinBtn">0</button>
<button class="pinBtn" id="pinDelete">‚å´</button>
</div>
</div>

<div id="welcomeMsgLeft">Welcome Boss John!</div>
<div id="welcomeMsgRight">Welcome Boss John!</div>
<div class="real-time-clock" id="realTimeClock"></div>
<div class="online-users" id="onlineUsers">Online: 0</div>
    
<img src="images/image.jpg" style="width:100%; max-height:100px; margin-top:0; display:block;">

<header>john secret chatüí≠</header>
<div id="typingIndicator">‚óè Someone is typing...</div>
<button id="refreshBtn">üîÑ Refresh</button>

<div class="chat-area" id="wishlist">
<ul id="wishlistList"></ul>
</div>

<div class="input-container">
<label class="file-label">üìé<input type="file" id="fileInput"></label>

<!-- ‚≠ê NEW ‚Äî Highlighter button -->
<button id="highlightBtn" style="background:#ccff00;color:#000;padding:12px 15px;border:none;border-radius:20px;cursor:pointer;">H</button>

<textarea id="item" placeholder="Type your message..."></textarea>


<button id="addButton" style="background: rgba(0,0,0,1);">Send</button>
</div>

<script>

/* PIN SYSTEM ‚Äî (ŸÉŸÖÿß ŸáŸà ÿ®ÿØŸàŸÜ ÿ™ÿπÿØŸäŸÑ) */
const CORRECT_PIN="4862";
let typedPIN="";
const pinBoxes=document.querySelectorAll(".pinBox");
const lockScreen=document.getElementById("lockScreen");
function showWelcomeParty() {
    const left = document.getElementById("welcomeMsgLeft");
    const right = document.getElementById("welcomeMsgRight");
    left.style.animation="slideFromLeft 3s forwards";
    right.style.animation="slideFromRight 3s forwards";
    for(let i=0;i<50;i++){
        const conf=document.createElement("div");
        conf.className="confetti-piece";
        conf.style.left=Math.random()*window.innerWidth+"px";
        conf.style.background=["red","#ff4d4d","#ff0000"][Math.floor(Math.random()*3)];
        conf.style.animationDuration=2+Math.random()*1+"s";
        document.body.appendChild(conf);
        setTimeout(()=>conf.remove(),3000);
    }
}
document.querySelectorAll(".pinBtn").forEach(btn=>{
    btn.onclick=()=>{
        const val=btn.textContent;
        if(/\d/.test(val)){
            if(typedPIN.length<4){ typedPIN+=val; pinBoxes[typedPIN.length-1].value="‚Ä¢"; }
            if(typedPIN.length===4){
                if(typedPIN===CORRECT_PIN){ lockScreen.style.display="none"; showWelcomeParty(); }
                else{ pinBoxes.forEach(b=>b.classList.add("shake"));
                    setTimeout(()=>{ pinBoxes.forEach(b=>{b.value=""; b.classList.remove("shake");}); typedPIN=""; },300);
                }
            }
        }
    };
});

document.addEventListener('keydown', (e) => {
    const key = e.key;
    if (/^\d$/.test(key)) {
        if (typedPIN.length < 4) {
            typedPIN += key;
            pinBoxes[typedPIN.length - 1].value = "‚Ä¢";
        }
        if (typedPIN.length === 4) {
            if (typedPIN === CORRECT_PIN) {
                lockScreen.style.display = "none";
                showWelcomeParty();
            } else {
                pinBoxes.forEach(b => b.classList.add("shake"));
                setTimeout(() => {
                    pinBoxes.forEach(b => { b.value = ""; b.classList.remove("shake"); });
                    typedPIN = "";
                }, 300);
            }
        }
    }
    if (key === "Backspace") {
        if (typedPIN.length > 0) {
            typedPIN = typedPIN.slice(0, -1);
            pinBoxes[typedPIN.length].value = "";
        }
    }
});

document.getElementById("pinDelete").onclick=()=>{ if(typedPIN.length>0){ typedPIN=typedPIN.slice(0,-1); pinBoxes[typedPIN.length].value=""; } };
document.getElementById("welBoss").onclick = ()=>{ showWelcomeParty(); };

/* CHAT FUNCTIONS */
const CLOUD_NAME = "drokorpop";
const UPLOAD_PRESET = "secret_chat_upload";

function formatDate(d){ return new Date(d).toLocaleString(); }

function linkify(text) {
    const urlPattern = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
    return text.replace(urlPattern, function(url) {
        return `<a href="${url}" target="_blank">${url}</a>`;
    });
}

function downloadUrl(url, filename="file") {
    fetch(url)
        .then(res => res.blob())
        .then(blob => {
            const a = document.createElement('a');
            const objectUrl = URL.createObjectURL(blob);
            a.href = objectUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(objectUrl);
        })
        .catch(err=>console.error(err));
}

/* ‚≠ê NEW ‚Äî Highlighter mode */
let highlightMode = false;
document.getElementById("highlightBtn").onclick = () => {
    highlightMode = !highlightMode;
    document.getElementById("highlightBtn").style.background = highlightMode ? "#aaff00" : "#ccff00";
};

/* BUBBLES */
function createBubble(item, isSection = false){
    const li=document.createElement("li");
    const bubble=document.createElement("div");
    bubble.className="bubble them " + (item.highlight ? "highlight-bubble" : "");

    const pre = document.createElement("pre");
    pre.style.margin = "0";
    pre.style.whiteSpace = "pre-wrap";
    pre.style.fontFamily = "inherit";
    pre.textContent = item.name || "";
    bubble.appendChild(pre);

    // ÿßŸÑŸÖŸÑŸÅÿßÿ™
    if(item.imageUrl){
        const img = document.createElement("img");
        img.src = item.imageUrl;
        bubble.appendChild(img);
    }
    if(item.videoUrl){
        const vid = document.createElement("video");
        vid.controls = true;
        const source = document.createElement("source");
        source.src = item.videoUrl;
        vid.appendChild(source);
        bubble.appendChild(vid);
    }
    if(item.fileUrl){
        const a = document.createElement("a");
        a.href = item.fileUrl;
        a.target = "_blank";
        a.style.color = "#4a90e2";
        a.textContent = "üìÑ Open File";
        bubble.appendChild(a);
    }

    const small = document.createElement("small");
    small.style.fontSize = "0.7rem";
    small.style.color = "#666";
    small.textContent = formatDate(item.createdAt);
    bubble.appendChild(small);

    const btnDiv = document.createElement("div");
    btnDiv.style.textAlign = "right";

    // Copy, Edit, Delete buttons
    const copyBtn = document.createElement("button");
    copyBtn.textContent = "üìã";
    copyBtn.addEventListener("click", ()=> copyText(item.name || ""));
    btnDiv.appendChild(copyBtn);

    const delBtn = document.createElement("button");
    delBtn.textContent = "‚ùå";
    delBtn.addEventListener("click", ()=> deleteItem(item._id, isSection));
    btnDiv.appendChild(delBtn);

    const editBtn = document.createElement("button");
    editBtn.textContent = "‚úèÔ∏è";
    editBtn.addEventListener("click", ()=> editItem(item._id, item.name || "", isSection));
    btnDiv.appendChild(editBtn);

    // Download buttons
    if(item.imageUrl){
        const dImg = document.createElement("button");
        dImg.textContent = "‚¨áÔ∏è";
        dImg.addEventListener("click", ()=> downloadUrl(item.imageUrl,"image.jpg"));
        btnDiv.appendChild(dImg);
    }
    if(item.videoUrl){
        const dVid = document.createElement("button");
        dVid.textContent = "‚¨áÔ∏è";
        dVid.addEventListener("click", ()=> downloadUrl(item.videoUrl,"video.mp4"));
        btnDiv.appendChild(dVid);
    }
    if(item.fileUrl){
        const dFile = document.createElement("button");
        dFile.textContent = "‚¨áÔ∏è";
        dFile.addEventListener("click", ()=> downloadUrl(item.fileUrl,"file"));
        btnDiv.appendChild(dFile);
    }

    bubble.appendChild(btnDiv);
    li.appendChild(bubble);
    return li;
}

function noScrollDown(){ document.querySelector(".chat-area").scrollTo({ top:0, behavior:'smooth'}); }

async function fetchWishlist(){
    try{
        const res=await fetch('/wishlist');
        const data=await res.json();
        const list=document.getElementById('wishlistList');
        list.innerHTML='';
        data.forEach(msg=>list.appendChild(createBubble(msg)));
        noScrollDown();
    }catch(e){ console.error(e); }
}

async function uploadFile(file){
    const formData=new FormData();
    formData.append("file",file);
    formData.append("upload_preset",UPLOAD_PRESET);
    const uploadUrl=`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`;
    const res=await fetch(uploadUrl,{method:"POST",body:formData});
    const data=await res.json();
    return data.secure_url;
}

async function addItem(){
    const input=document.getElementById('item');
    const fileInput=document.getElementById('fileInput');
    const text=input.value.trim();
    let imageUrl=null,videoUrl=null,fileUrl=null;

    if(fileInput.files.length>0){
        const file=fileInput.files[0];
        const url=await uploadFile(file);
        if(file.type.startsWith("image")) imageUrl=url;
        else if(file.type.startsWith("video")) videoUrl=url;
        else fileUrl=url;
    }

    if(!text && !imageUrl && !videoUrl && !fileUrl) return;

    await fetch('/wishlist',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
            name:text,
            imageUrl,
            videoUrl,
            fileUrl,
            highlight: highlightMode,  // ‚≠ê NEW
            createdAt:new Date().toISOString()
        })
    });

    input.value=''; 
    fileInput.value="";
    highlightMode = false;
    document.getElementById("highlightBtn").style.background = "#ccff00";

    fetchWishlist();
}


// DELETE item
async function deleteItem(id, isSection = false) {
    const url = isSection ? `/messages/${id}` : `/wishlist/${id}`;
    await fetch(url, { method:'DELETE' });
    isSection ? loadSectionMessages() : fetchWishlist();
}
/* ‚≠ê NEW ‚Äî Edit message */
// Edit message
async function editItem(id, oldText, isSection = false) {
    const newText = prompt("Edit your message:", oldText);
    if (!newText || newText.trim() === oldText) return;
    const url = isSection ? `/messages/${id}` : `/wishlist/${id}`;
    await fetch(url, {
        method: 'PUT',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ name: newText })
    });
    isSection ? loadSectionMessages() : fetchWishlist();
}

    



function copyText(t){ navigator.clipboard.writeText(t); }

setInterval(()=>{ document.getElementById('realTimeClock').textContent=new Date().toLocaleTimeString(); },1000);
setInterval(async()=>{
    try{
        const r=await fetch('/online-users');
        const d=await r.json();
        document.getElementById('onlineUsers').textContent=`Online: ${d.count}`;
    }catch(e){}
},3000);

['click','keydown','mousemove'].forEach(e=>{ document.addEventListener(e,()=>{ fetch('/heartbeat',{method:'POST'}); }); });

let typingTimeout;
document.getElementById('item').addEventListener('input',()=>{
    document.getElementById('typingIndicator').style.display='block';
    clearTimeout(typingTimeout);
    typingTimeout=setTimeout(()=>{ document.getElementById('typingIndicator').style.display='none'; },1000);
});

fetchWishlist();
document.getElementById('addButton').onclick=addItem;
document.getElementById('item').onkeydown = (e) => {
    if (e.key === 'Enter' && e.ctrlKey) {
        e.preventDefault();
        addItem();
    }
};

document.getElementById('refreshBtn').onclick=async()=>{
    const btn=document.getElementById('refreshBtn'); btn.disabled=true;
    await fetchWishlist(); btn.disabled=false;
};
    const textarea = document.getElementById("item");
textarea.addEventListener("input", () => {
    textarea.style.height = "auto";
    textarea.style.height = textarea.scrollHeight + "px";
});


/* ===== SECTION SYSTEM ===== */
let currentSectionId = null;

function initSections() {
    const header = document.querySelector("header");
    const bar = document.createElement("div");
    bar.id = "sectionsBar";
    header.after(bar);
    loadSections();
}

/* Load sections from server */
async function loadSections() {
    const res = await fetch('/sections');
    const sections = await res.json();
    const bar = document.getElementById("sectionsBar");
    bar.innerHTML = "";

    // ‚≠ê General
    const generalDiv = document.createElement("div");
    generalDiv.className = "sectionTab";
    generalDiv.textContent = "General";
    generalDiv.onclick = () => selectSection(null, generalDiv);
    bar.appendChild(generalDiv);

    // ÿ®ÿßŸÇŸä ÿßŸÑÿ≥ŸÉÿ¥ŸÜÿßÿ™
    sections.forEach(sec => {
        const div = document.createElement("div");
        div.className = "sectionTab";
        div.textContent = sec.name;
        div.onclick = () => selectSection(sec._id, div);
        bar.appendChild(div);
    });

    // ÿ£ÿ≤ÿ±ÿßÿ± + Ÿà -
    const add = document.createElement("div");
    add.className = "sectionTab add";
    add.textContent = "+";
    add.onclick = addSection;
    bar.appendChild(add);

    const del = document.createElement("div");
    del.className = "sectionTab del";
    del.textContent = "-";
    del.onclick = deleteSection;
    bar.appendChild(del);

    // ÿßÿÆÿ™Ÿäÿßÿ± General ÿ™ŸÑŸÇÿßÿ¶ŸäŸãÿß
    currentSectionId = null;
    generalDiv.classList.add("active");
    loadSectionMessages();
}

async function selectSection(id, el){
    currentSectionId = id;
    document.querySelectorAll(".sectionTab").forEach(t=>t.classList.remove("active"));
    el.classList.add("active");
    loadSectionMessages();
}

async function loadSectionMessages() {
    const list = document.getElementById("wishlistList");
    list.innerHTML = "";

    let url = currentSectionId ? `/messages/${currentSectionId}` : '/wishlist';
    const res = await fetch(url);
    const data = await res.json();

    data.forEach(msg => list.appendChild(createBubble(msg, !!currentSectionId)));
}


/* Add Section */
async function addSection(){
    const name = prompt("ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖ ÿßŸÑÿ≥ŸÉÿ¥ŸÜ ÿßŸÑÿ¨ÿØŸäÿØ:");
    if(!name) return;
    await fetch('/sections',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({name})
    });
    loadSections();
}

/* Delete Section */
async function deleteSection(){
    if(!currentSectionId) return;
    if(!confirm("ŸáŸÑ ÿßŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ÿßŸÜŸÉ ÿπÿßŸäÿ≤ ÿ™ŸÖÿ≥ÿ≠ ÿßŸÑÿ≥ŸÉÿ¥ŸÜ ÿØÿß ŸàŸÉŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÑŸä ŸÅŸäŸáÿü")) return;
    await fetch(`/sections/${currentSectionId}`,{method:'DELETE'});
    currentSectionId = null;
    loadSections();
}

/* Add item to section or General */
async function addItemToSection() {
    const input = document.getElementById("item");
    const text = input.value.trim();
    if(!text) return;

    const body = {
        name: text,
        highlight: highlightMode,
        createdAt: new Date().toISOString()
    };

    if(currentSectionId){
        body.sectionId = currentSectionId;
        await fetch('/messages', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(body)
        });
    } else {
        await fetch('/wishlist', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(body)
        });
    }

    input.value = "";
    highlightMode = false;
    document.getElementById("highlightBtn").style.background = "#ccff00";
    loadSectionMessages();
}

/* Init Sections after DOM loaded */
window.addEventListener("DOMContentLoaded", initSections);

/* ÿ±ÿ®ÿ∑ ÿ≤ÿ± ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿ®ÿßŸÑŸÄ textarea */
document.getElementById('addButton').onclick = addItemToSection;
document.getElementById('item').onkeydown = (e) => {
    if (e.key === 'Enter' && e.ctrlKey) {
        e.preventDefault();
        addItemToSection();
    }
};
</script>


</body>
</html> 
