<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="icon" type="image/jpeg" href="images/image.jpg">

<title>John Secret Chatüí≠</title>
<style>
* { box-sizing: border-box; }
html, body { touch-action: manipulation; margin:0; padding:0; }
body { font-family: Arial, sans-serif; background: #e5e5e5; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

/* HEADER */
header { 
    background: rgba(0,0,0,1);
    color: #fff;
    text-align: center;
    padding: 1px 10px;
    font-size: 1.3rem;
    width: 100%;
    position: relative;
    max-height: 30px;
    overflow: hidden;
}

/* CHAT AREA */
.chat-area {
    flex: 1;
    margin-top: 20px;
    margin-bottom: 80px;
    padding: 10px;
    overflow-y: auto;
    background: #f2f2f2;
    display: flex;
    flex-direction: column-reverse;
}

#wishlistList {
    list-style:none;
    padding:0;
    margin:0;
    display:flex;
    flex-direction:column-reverse;
    gap:10px;
}

/* ‚≠ê FIX ‚Äî preserve spaces & line breaks */
.bubble {
    background:white;
    padding:12px 15px;
    border-radius:20px;
    max-width:80%;
    box-shadow:0 2px 4px rgba(0,0,0,0.1);
    display:flex;
    flex-direction:column;
    gap:5px;

    white-space: pre-wrap;   /* ‚≠ê IMPORTANT */
    word-break: break-word; /* ‚≠ê IMPORTANT */
}

.highlight-bubble {
    background: #ccff00 !important;
    width: 100% !important;
    border-radius: 10px !important;
    padding: 15px !important;
}

/* INPUT */
.input-container {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background:#fff;
    padding:8px 10px;
    display:flex;
    align-items:center;
    gap:8px;
    box-shadow:0 -2px 4px rgba(0,0,0,0.15);
}

.input-container input[type="text"] {
    flex:1;
    padding:12px;
    font-size:1rem;
    border-radius:20px;
    border:1px solid #ccc;
}
</style>
</head>

<body>

<header>john secret chatüí≠</header>

<div class="chat-area">
<ul id="wishlistList"></ul>
</div>

<div class="input-container">
<input type="text" id="item" placeholder="Type your message...">
<button id="addButton">Send</button>
</div>

<script>
/* =========================
   SAFE TEXT HELPERS
========================= */
function escapeHTML(text) {
    return text
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;");
}

/* =========================
   CREATE MESSAGE BUBBLE
========================= */
function createBubble(item){
    const li = document.createElement("li");
    const bubble = document.createElement("div");

    bubble.className = "bubble " + (item.highlight ? "highlight-bubble" : "");

    /* ‚≠ê FIX ‚Äî DO NOT LOSE SPACES */
    const safeText = escapeHTML(item.name || "");

    bubble.innerHTML = `
        <div>${safeText}</div>
        <small style="font-size:0.7rem;color:#666;">
            ${new Date(item.createdAt).toLocaleString()}
        </small>
        <div style="text-align:right;">
            <button onclick="copyText(\`${safeText.replace(/`/g,"\\`")}\`)">üìã</button>
            <button onclick="deleteItem('${item._id}')">‚ùå</button>
        </div>
    `;

    li.appendChild(bubble);
    return li;
}

/* =========================
   SEND MESSAGE
========================= */
async function addItem(){
    const input = document.getElementById('item');

    /* ‚≠ê FIX ‚Äî REMOVE .trim() */
    const text = input.value;

    if (!text) return;

    await fetch('/wishlist',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
            name: text,
            createdAt: new Date().toISOString()
        })
    });

    input.value='';
    fetchWishlist();
}

/* =========================
   FETCH
========================= */
async function fetchWishlist(){
    const res = await fetch('/wishlist');
    const data = await res.json();
    const list = document.getElementById('wishlistList');
    list.innerHTML='';
    data.forEach(m => list.appendChild(createBubble(m)));
}

/* =========================
   COPY
========================= */
function copyText(t){
    navigator.clipboard.writeText(t);
}

document.getElementById('addButton').onclick = addItem;
document.getElementById('item').onkeydown = e => {
    if(e.key === 'Enter') addItem();
};

fetchWishlist();
</script>

</body>
</html>
